---
description: Architecture phase - system design and API specification
---

# 架构阶段 (Phase 3/4)

系统架构设计、API 设计、数据模型设计。

## 前置条件

- Gate 2 已通过
- PRD 文档已完成

## 当前 Agent

```
🏗️ 架构师 (Architect)
- 模型: Opus (关键决策)
- 职责: 系统架构、技术选型、API 设计
- 辅助: 📋 PM
```

---

## 执行流程

### Step 1: 系统架构设计

```
🏗️ [架构师] 系统架构设计

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 架构风格选择

根据项目需求，推荐以下架构:

[1] 🏢 单体架构 (推荐)
    适合: MVP、小团队、快速迭代
    优点: 简单、部署容易

[2] 🔌 微服务架构
    适合: 大型项目、多团队
    优点: 可扩展、独立部署

[3] ☁️ Serverless
    适合: 事件驱动、低运维
    优点: 自动扩容、按需付费

[4] 🔍 查看详细对比

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Step 2: 架构图

```
🏗️ [架构师] 系统架构图

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 系统架构

┌─────────────────────────────────────────────┐
│                   客户端                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐     │
│  │   Web   │  │  Mobile │  │  Admin  │     │
│  └────┬────┘  └────┬────┘  └────┬────┘     │
└───────┼────────────┼────────────┼───────────┘
        │            │            │
        └────────────┼────────────┘
                     │
┌────────────────────┼────────────────────────┐
│              API Gateway                     │
│         (认证 / 限流 / 路由)                  │
└────────────────────┼────────────────────────┘
                     │
┌────────────────────┼────────────────────────┐
│                 服务层                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 用户服务  │  │ 核心业务  │  │ 通知服务  │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  │
└───────┼─────────────┼─────────────┼─────────┘
        │             │             │
┌───────┴─────────────┴─────────────┴─────────┐
│                  数据层                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ Database │  │   Cache  │  │  Storage │  │
│  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────┘

确认架构设计:
[1] ✅ 确认
[2] 📝 修改
[3] 🔍 查看详细说明

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Step 3: API 设计

```
🏗️ [架构师] API 设计

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## API 设计规范

- 风格: RESTful
- 认证: JWT
- 版本: /api/v1/

## API 端点列表

### 用户模块 (/api/v1/users)

| 方法 | 端点 | 描述 | 认证 |
|------|------|------|------|
| POST | /register | 用户注册 | 否 |
| POST | /login | 用户登录 | 否 |
| GET | /me | 获取当前用户 | 是 |
| PUT | /me | 更新用户信息 | 是 |

### 核心业务模块 (/api/v1/[模块])

| 方法 | 端点 | 描述 | 认证 |
|------|------|------|------|
| GET | / | 列表 | 是 |
| POST | / | 创建 | 是 |
| GET | /:id | 详情 | 是 |
| PUT | /:id | 更新 | 是 |
| DELETE | /:id | 删除 | 是 |

## 响应格式

```json
{
  "success": true,
  "data": {},
  "error": null,
  "meta": {
    "timestamp": "",
    "requestId": ""
  }
}
```

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] ✅ 确认 API 设计
[2] ➕ 添加端点
[3] 📝 修改端点
[4] 🔍 查看详细规范
```

### Step 4: 数据模型设计

```
🏗️ [架构师] 数据模型设计

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 数据模型

### users 表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | UUID | PK | 主键 |
| email | VARCHAR(255) | UNIQUE | 邮箱 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希 |
| name | VARCHAR(100) | | 用户名 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### [业务表]

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| ... | ... | ... | ... |

## ER 关系图

users 1 ─── N [业务表]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] ✅ 确认数据模型
[2] ➕ 添加表
[3] 📝 修改字段
```

### Step 5: 项目结构

```
🏗️ [架构师] 项目结构设计

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 目录结构

```
project/
├── src/
│   ├── routes/         # API 路由
│   ├── services/       # 业务逻辑
│   ├── models/         # 数据模型
│   ├── middleware/     # 中间件
│   ├── utils/          # 工具函数
│   ├── types/          # 类型定义
│   └── config/         # 配置文件
├── tests/              # 测试文件
├── docs/               # 文档
└── scripts/            # 脚本
```

## 命名规范

- 文件: kebab-case (user-service.ts)
- 类: PascalCase (UserService)
- 函数: camelCase (getUserById)
- 常量: UPPER_SNAKE_CASE (MAX_RETRIES)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] ✅ 确认项目结构
[2] 📝 修改结构
```

---

## 阶段产出

### 生成架构文档

创建 `docs/ARCHITECTURE.md`:

```markdown
# 系统架构文档

## 1. 架构概述
[架构风格和设计理念]

## 2. 系统架构图
[ASCII 架构图]

## 3. 技术栈详情
[完整技术栈]

## 4. API 设计
[API 规范和端点]

## 5. 数据模型
[表结构和关系]

## 6. 项目结构
[目录和命名规范]
```

### 更新 CLAUDE.md

```markdown
## 架构规则

### 代码组织
[目录结构]

### 命名规范
- 文件: kebab-case
- 类: PascalCase
- 函数: camelCase

## API 规范

- 风格: RESTful
- 认证: JWT
- 前缀: /api/v1/

## 安全规则

- 所有接口需要认证 (除登录注册)
- 敏感数据加密存储
- 输入验证必须完整
```

---

## Gate 3 检查清单

```
🚧 Gate 3 检查

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 系统架构设计完成
✅ API 设计完成
✅ 数据模型设计完成
✅ 项目结构确定
✅ 架构文档已生成
✅ CLAUDE.md 已更新

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Gate 3 通过！进入开发阶段...
```
