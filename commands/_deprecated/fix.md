---
description: Execute approved fix in production mode (minimal changes only)
---

# 执行修复 (运维项目 - Phase 3/5)

## 前置检查

确认审批阶段 (`approve`) 已通过。

## 🔴 修复规则

```
⚠️ 运维模式 - 严格修复规则

执行修复时，必须遵守以下规则：

✅ 允许:
- 修改诊断中确定的文件
- 只修改必要的代码行
- 添加必要的错误处理
- 添加必要的日志

❌ 禁止:
- 修改未审批的文件
- 重构代码结构
- 添加新功能
- 删除现有代码（除非明确是 bug 源）
- 修改配置文件（除非必要）
- 添加新依赖
```

## 修复流程

### 🔧 1. 修复准备

```markdown
## 修复准备检查

### 变更信息确认
- 变更编号: CHG-XXXXXXXX-XX
- 审批状态: ✅ 已通过
- 修改文件: [列表]

### 环境确认
- [ ] 本地环境正常
- [ ] 测试环境可用
- [ ] 回滚方案就绪
- [ ] 监控面板打开

### 备份
执行前自动备份将要修改的文件:
```bash
# 自动执行
cp [file] [file].backup.[timestamp]
```
```

### 💻 2. 执行修复

```markdown
## 修复执行

### 按照审批方案修改

修改文件: [file]
修改内容:
```diff
- [旧代码]
+ [新代码]
```

### 修改日志

| 时间 | 文件 | 操作 | 说明 |
|------|------|------|------|
| [time] | [file] | 修改 | [说明] |
```

### 🔍 3. 修改验证

```markdown
## 修改验证

### 代码检查
- [ ] 修改符合审批方案
- [ ] 没有额外改动
- [ ] 代码风格一致
- [ ] 没有语法错误

### 自动检查
```bash
# 自动执行
npm run lint [modified files]
npm run typecheck
```

### 本地测试
```bash
# 执行相关测试
npm run test [related tests]
```
```

### ⚠️ 4. 变更范围检查

每次保存时自动检查：

```markdown
## 变更范围检查

审批的文件: [列表]
实际修改的文件: [列表]

状态: ✅ 符合 / ⚠️ 超出范围

如果超出范围:
```
⛔ 变更范围超出审批

检测到修改了未审批的文件：
- [file1]
- [file2]

请撤销这些修改或重新提交审批。
```
```

---

## 修复完成

```markdown
## 修复完成报告

### 变更信息
- 变更编号: CHG-XXXXXXXX-XX
- 完成时间: [timestamp]

### 修改汇总
| 文件 | 添加行 | 删除行 | 修改行 |
|------|--------|--------|--------|
| | | | |
| **合计** | | | |

### 检查结果
- Lint: ✅ 通过
- TypeCheck: ✅ 通过
- 相关测试: ✅ 通过

### 备份文件
[备份文件列表]
```

更新 `PROJECT_STATE.json`:
```json
{
  "phases": {
    "fix": {
      "status": "completed",
      "completedAt": "[timestamp]",
      "changeId": "CHG-XXXXXXXX-XX",
      "modifiedFiles": [],
      "backupFiles": []
    },
    "verify": { "status": "in_progress" }
  }
}
```

输出：
```
✅ 修复执行完成！

📋 变更编号: CHG-XXXXXXXX-XX
📁 修改文件: X 个
📝 修改行数: X 行

✅ 检查结果:
- Lint: 通过
- TypeCheck: 通过
- 相关测试: 通过

💾 备份已创建:
[备份文件列表]

⚠️ 注意：修复尚未验证，请勿部署！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚀 运维项目流程:
✓ 诊断 → ✓ 审批 → ✓ 修复 → ✔️ 验证 → 📦 输出
                             ↑
                           下一步
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

下一步：运行 /project-optimizer:verify 验证修复
```
