---
description: Diagnose issues in production projects (strict mode)
---

# 诊断问题 (运维项目 - Phase 1/5)

## 适用场景

项目已上线运行，只做问题修复，严格红线保护。

## ⚠️ 运维模式警告

```
🔴 运维模式已激活

严格红线保护：
- ❌ 禁止新增功能
- ❌ 禁止重构代码
- ❌ 禁止修改架构
- ❌ 禁止删除文件
- ✅ 只允许修复 Bug
- ✅ 只允许最小化改动

所有修改必须经过审批！
```

## 诊断任务

### 🔎 1. 问题收集

```markdown
## 问题信息

### 问题来源
- [ ] 用户反馈
- [ ] 监控告警
- [ ] 日志分析
- [ ] 定期巡检

### 问题描述
**现象**: [用户看到的现象]
**影响范围**: [影响多少用户/功能]
**发生频率**: [频繁/偶发/必现]
**首次发现时间**: [时间]

### 复现步骤
1. [步骤1]
2. [步骤2]
3. [步骤3]

### 期望行为
[正确的行为应该是什么]

### 实际行为
[目前的错误行为]
```

### 🔍 2. 日志分析

```markdown
## 日志分析

### 相关日志
```
[错误日志片段]
```

### 错误追踪
- 错误类型: [Error Type]
- 错误位置: [File:Line]
- 调用栈: [Stack Trace]

### 关联请求
- 请求 ID: [如有]
- 用户 ID: [如有]
- 时间戳: [时间]
```

### 🎯 3. 根因分析

```markdown
## 根因分析

### 5 Why 分析
1. 为什么发生 [现象]？
   → 因为 [原因1]
2. 为什么 [原因1]？
   → 因为 [原因2]
3. 为什么 [原因2]？
   → 因为 [原因3]
4. 为什么 [原因3]？
   → 因为 [原因4]
5. 为什么 [原因4]？
   → 根因: [根本原因]

### 问题定位
- 问题模块: [module]
- 问题文件: [file]
- 问题代码: [line range]

### 触发条件
- [条件1]
- [条件2]
```

### ⚠️ 4. 影响评估

```markdown
## 影响评估

### 严重程度
- [ ] P0 - 致命 (系统不可用)
- [ ] P1 - 严重 (核心功能不可用)
- [ ] P2 - 中等 (部分功能受影响)
- [ ] P3 - 轻微 (边缘功能/体验问题)

### 影响范围
- 受影响用户: X 人/X%
- 受影响功能: [功能列表]
- 业务影响: [描述]

### 紧急程度
- [ ] 立即修复 (P0/P1)
- [ ] 尽快修复 (P2)
- [ ] 计划修复 (P3)
```

### 🛠️ 5. 修复方案

```markdown
## 修复方案

### 方案描述
[简要描述修复方案]

### 修改范围
| 文件 | 修改类型 | 修改行数 | 风险 |
|------|----------|----------|------|
| [file] | 修改 | ~X 行 | 低/中/高 |

### 最小化原则
- ✅ 只修改必要的代码
- ✅ 不改变现有逻辑结构
- ✅ 不引入新依赖
- ✅ 保持 API 兼容

### 回滚方案
[如果修复失败，如何回滚]

### 验证方案
[如何验证修复有效]
```

---

## 输出产物

生成 `docs/DIAGNOSIS.md` 包含完整诊断报告。

更新 `PROJECT_STATE.json`:
```json
{
  "projectType": "production",
  "currentPhase": 2,
  "phases": {
    "diagnose": { "status": "completed", "completedAt": "[timestamp]" },
    "approve": { "status": "in_progress" }
  },
  "diagnosis": {
    "issueId": "[ID]",
    "severity": "P1",
    "rootCause": "[描述]",
    "proposedFix": "[描述]",
    "filesAffected": []
  }
}
```

输出：
```
✅ 诊断完成！

📋 诊断摘要：
- 问题类型: [类型]
- 严重程度: P1
- 根因: [简述]
- 影响范围: X 个功能

🛠️ 修复方案：
- 修改文件: X 个
- 修改行数: ~X 行
- 风险等级: 低

⚠️ 运维模式：所有修改必须经过审批

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚀 运维项目流程:
✓ 诊断 → 👆 审批 → 🔧 修复 → ✔️ 验证 → 📦 输出
           ↑
         下一步
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

下一步：运行 /project-optimizer:approve 提交审批
```
