---
description: Split large tasks into smaller subtasks with parallel execution
---

# 任务分割系统

将大型任务智能分割成多个小任务，支持并行执行。

## 自动驾驶行为

开发阶段自动触发任务分割，无需手动调用。

---

## 分割规则

### 触发条件

```markdown
自动分割触发条件:

- 预估代码 > 200 行
- 涉及文件 > 3 个
- 有多个独立子功能
- 复杂度评估 > 中等
```

### 任务规模定义

| 规模 | 代码行数 | 文件数 | Token 预算 | 推荐模型 |
|------|----------|--------|------------|----------|
| S (小) | < 50 | 1 | 8K | **Haiku** |
| M (中) | 50-200 | 1-3 | 32K | **Sonnet** |
| L (大) | 200-500 | 3-5 | 100K | **Sonnet** |
| XL (超大) | > 500 | > 5 | 200K | **Opus** |

---

## 智能模型分配

任务分割后，每个子任务**自动分配最优模型**，实现成本优化。

### 分配原则

```
原则 1: 优先按任务类型分配
  - 模板化/配置 → Haiku
  - 复杂编码 → Sonnet
  - 架构决策 → Opus

原则 2: 按子任务规模分配
  - S 规模 → Haiku (快速 + 低成本)
  - M/L 规模 → Sonnet (平衡)
  - XL 规模 → Opus (关键任务)

原则 3: 成本优化
  - 大任务分割后，小任务降级为 Haiku
  - 总成本 < 单一大任务使用 Opus
```

### 成本节省示例

```
原始任务: 600 行代码 (XL) → 单一 Opus → $$$$$

分割后:
  T1: 30 行 (S)  → Haiku  → $
  T2: 120 行 (M) → Sonnet → $$
  T3: 100 行 (M) → Sonnet → $$
  T4: 80 行 (M)  → Sonnet → $$
  T5: 40 行 (S)  → Haiku  → $

总成本: $ + $$ × 3 + $ = $$$ (节省 40%)
```

**💡 提示**: 查看完整模型选择算法，运行 `/project-optimizer:model-selection`

---

## 分割流程

### Step 1: 任务分析

```
🔄 任务分割分析

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 原始任务

[任务描述]

## 分析结果

- 预估代码量: ~350 行
- 涉及文件数: 5 个
- 复杂度: 高
- 是否可分割: ✅ 是

## 识别的子功能

1. [子功能1] - 独立
2. [子功能2] - 独立
3. [子功能3] - 依赖 1, 2
4. [子功能4] - 依赖 3

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Step 2: 生成子任务 + 模型分配

```
🔄 生成子任务 + 智能模型分配

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 子任务列表（含模型选择）

### 任务组 A (可并行)

| ID | 任务 | 规模 | Agent | 模型 | 选择原因 |
|----|------|------|-------|------|----------|
| T1 | [子功能1] | M (120行) | 💻 开发者 | **Sonnet** | 复杂编码 |
| T2 | [子功能2] | S (30行) | 💻 开发者 | **Haiku** | 简单配置 |

### 任务组 B (依赖组A)

| ID | 任务 | 规模 | 依赖 | Agent | 模型 | 选择原因 |
|----|------|------|------|-------|------|----------|
| T3 | [子功能3] | M (100行) | T1,T2 | 💻 开发者 | **Sonnet** | 业务逻辑 |

### 任务组 C (依赖组B)

| ID | 任务 | 规模 | 依赖 | Agent | 模型 | 选择原因 |
|----|------|------|------|-------|------|----------|
| T4 | [子功能4] | S (40行) | T3 | 💻 开发者 | **Haiku** | 简单实现 |

### 审核任务

| ID | 任务 | 依赖 | Agent | 模型 | 选择原因 |
|----|------|------|-------|------|----------|
| R1 | 代码审核 | T4 | 👁️ 审核员 | **Sonnet** | 代码审查 |

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 模型分配统计

| 模型 | 任务数 | 代码行数 | 预估成本 |
|------|--------|----------|----------|
| Haiku | 2 | 70 行 | $ + $ = $$ |
| Sonnet | 3 | 220 行 | $$ × 3 = $$$$$$ |
| Opus | 0 | 0 行 | 0 |

**原始任务**: 290 行 (L) → Opus → $$$$$$$
**分割后总成本**: $$ + $$$$$$ = $$$$$$$$ (节省约 40%)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Step 3: 执行计划

```
🔄 执行计划

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 执行顺序

阶段 1: 并行执行 T1, T2
         ┌─────┐  ┌─────┐
         │ T1  │  │ T2  │
         │  M  │  │  S  │
         └──┬──┘  └──┬──┘
            └────┬───┘
                 ↓
阶段 2: 执行 T3
         ┌─────┐
         │ T3  │
         │  M  │
         └──┬──┘
            ↓
阶段 3: 执行 T4
         ┌─────┐
         │ T4  │
         │  S  │
         └──┬──┘
            ↓
阶段 4: 代码审核
         ┌─────┐
         │ R1  │
         │审核 │
         └─────┘

## 预估

- 总子任务: 5 个
- 可并行: 2 个 (节省 ~30% 时间)
- 预估 Token: ~80K

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] ▶️ 开始执行
[2] 📝 调整任务
[3] 🔍 查看详情
```

---

## 子任务模板

每个子任务包含:

```markdown
## 子任务: T1 - [名称]

### 目标
[清晰的单一目标]

### 范围
- 文件: [涉及的文件]
- 函数: [涉及的函数/类]

### 输入
- [前置条件]
- [依赖的输出]

### 输出
- [预期产出]
- [文件变更]

### 验收标准
- [ ] [标准1]
- [ ] [标准2]

### 约束
- 规模: M (120 行代码)
- Token 预算: 32K
- Agent: 💻 开发者
- **模型: Sonnet** (自动选择: 复杂编码)
- 预估成本: $$

### 模型选择理由
- 任务类型: 复杂编码 → 强制 Sonnet
- 代码规模: M (50-200 行) → 推荐 Sonnet
- 业务逻辑复杂度: 中 → 需要上下文理解
```

---

## 执行进度

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 任务执行进度
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

总进度: ████████████░░░░░░░░ 60%

阶段 1: ████████████████████ 100%
阶段 2: ████████████████████ 100%
阶段 3: ████████░░░░░░░░░░░░ 40%
阶段 4: ░░░░░░░░░░░░░░░░░░░░ 0%

[✅ T1] [✅ T2] [✅ T3] [🔄 T4] [⬜ R1]

当前: T4 - [子功能4]
Agent: 💻 开发者 (Haiku)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 手动命令

```bash
/project-optimizer:split [任务描述]   # 分割指定任务
/project-optimizer:split --current    # 分割当前任务
/project-optimizer:split --status     # 查看分割状态
```

---

## 配置存储

`.claude/PROJECT_STATE.json`:

```json
{
  "tasks": {
    "current": {
      "id": "T4",
      "name": "[子功能4]",
      "size": "S",
      "agent": "developer",
      "model": "haiku",
      "status": "in_progress"
    },
    "queue": [],
    "completed": [
      { "id": "T1", "completedAt": "[timestamp]" },
      { "id": "T2", "completedAt": "[timestamp]" },
      { "id": "T3", "completedAt": "[timestamp]" }
    ],
    "split": {
      "originalTask": "[原始任务]",
      "subtasks": ["T1", "T2", "T3", "T4", "R1"],
      "groups": [
        { "id": "A", "tasks": ["T1", "T2"], "parallel": true },
        { "id": "B", "tasks": ["T3"], "parallel": false },
        { "id": "C", "tasks": ["T4"], "parallel": false },
        { "id": "D", "tasks": ["R1"], "parallel": false }
      ]
    }
  }
}
```
