---
description: Development phase - implementation with task splitting and multi-agent
---

# 开发阶段 (Phase 4/6)

代码实现、代码审核、功能集成。

## 前置条件

- Gate 1 已通过（规划阶段完成）
- 架构设计已完成

## 任务追踪

**所有任务状态实时更新到 `.claude/TASKS.md`**

| 操作 | 更新位置 |
|------|----------|
| 开始任务 | TASKS.md → 活跃任务 → 进行中 |
| 完成任务 | TASKS.md → 已完成任务 |
| 发现问题 | TASKS.md → 发现的问题 |
| 日志记录 | TASKS.md → 会话日志 |

## 当前 Agent

```
💻 开发者 (Developer)
- 模型: 根据任务复杂度自动分配
- 职责: 代码实现、测试、优化
- 辅助: 👁️ 审核员
```

---

## 自动模型选择

开发阶段采用**智能模型分配**，根据任务特征自动选择最优模型，优化 Token 使用和成本。

### 选择策略（三层决策）

```
┌─────────────────────────────────────┐
│  1. 任务类型检查（最高优先级）        │
│     简单 CRUD → Haiku               │
│     复杂编码 → Sonnet               │
│     架构决策 → Opus                 │
└─────────────┬───────────────────────┘
              ↓ (如无强制类型)
┌─────────────────────────────────────┐
│  2. 任务规模评估                     │
│     S (< 50 行) → Haiku             │
│     M (50-200 行) → Sonnet          │
│     L/XL (> 200 行) → Sonnet/Opus   │
└─────────────┬───────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  3. 阶段基础模型                     │
│     开发阶段默认: 动态分配           │
└─────────────────────────────────────┘
```

### 模型分配示例

| 任务 | 类型 | 规模 | 选择模型 | 原因 |
|------|------|------|----------|------|
| 项目初始化 | 模板化 | S | **Haiku** | 标准化操作 |
| 数据库配置 | 配置文件 | S | **Haiku** | 简单配置 |
| 认证中间件 | 复杂编码 | M | **Sonnet** | 安全逻辑 |
| 用户注册 | 复杂编码 | M | **Sonnet** | 业务逻辑 |
| 核心业务 | 复杂编码 | L | **Sonnet** | 上下文理解 |
| 架构重构 | 架构决策 | XL | **Opus** | 关键决策 |

**💡 提示**: 查看完整选择算法和成本优化策略，运行 `/project-optimizer:model-selection`

---

## 执行流程

### Step 1: 任务分解

**任务列表自动写入 `.claude/TASKS.md`**

```
💻 [开发者] 任务分解

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 开发任务列表

基于 PRD 和架构设计，自动生成开发任务:

📝 任务列表将写入 .claude/TASKS.md

### 基础设施 (Infrastructure)
| ID | 任务 | 规模 | 状态 |
|----|------|------|------|
| I1 | 项目初始化 | S | ⬜ |
| I2 | 数据库配置 | S | ⬜ |
| I3 | 认证中间件 | M | ⬜ |

### 功能开发 (Features)
| ID | 任务 | 规模 | 依赖 | 状态 |
|----|------|------|------|------|
| F1 | 用户注册 | M | I1,I2 | 🔒 |
| F2 | 用户登录 | M | I3 | 🔒 |
| F3 | [核心功能1] | L | F2 | 🔒 |
| F4 | [核心功能2] | M | F3 | 🔒 |

### 测试 (Testing)
| ID | 任务 | 规模 | 依赖 | 状态 |
|----|------|------|------|------|
| T1 | 单元测试 | M | F1-F4 | 🔒 |
| T2 | 集成测试 | M | T1 | 🔒 |

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] ✅ 确认任务列表
[2] ➕ 添加任务
[3] 📝 修改任务
[4] 🔄 重新分解
```

### Step 2: 自动任务分配 + 模型选择

```
💻 [协调者] 任务分配 + 模型分配

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 执行计划 (含智能模型分配)

### 阶段 1: 基础设施 (可并行)

┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│     I1      │  │     I2      │  │     I3      │
│  项目初始    │  │   数据库     │  │    认证      │
│   Haiku     │  │   Haiku     │  │   Sonnet    │
│  (模板化)    │  │  (配置)     │  │ (复杂编码)   │
└─────────────┘  └─────────────┘  └─────────────┘
    ↓                ↓                ↓
    └────────────────┴────────────────┘
                     ↓
### 阶段 2: 核心功能 (顺序执行)

┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│     F1      │──▶│     F2      │──▶│     F3      │
│  用户注册    │   │  用户登录    │   │  核心功能    │
│   Sonnet    │   │   Sonnet    │   │   Sonnet    │
│ (复杂编码)   │   │ (复杂编码)   │   │ (L规模)     │
└─────────────┘   └─────────────┘   └─────────────┘
                                         ↓
### 阶段 3: 测试 & 审核

┌─────────────┐   ┌─────────────┐
│     T1      │──▶│     T2      │
│  单元测试    │   │  集成测试    │
│   Sonnet    │   │   Sonnet    │
│ (代码理解)   │   │ (M规模)     │
└─────────────┘   └─────────────┘
       ↓
┌─────────────────────────────┐
│       👁️ 代码审核           │
│         Sonnet              │
│      (代码审查)              │
└─────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 模型分配统计

| 模型 | 任务数 | 占比 | 预估 Token |
|------|--------|------|------------|
| Haiku | 2 | 25% | ~20K |
| Sonnet | 6 | 75% | ~120K |
| Opus | 0 | 0% | 0 |

**总预估**: ~140K Token (节省约 30% vs 全 Opus)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] ▶️ 开始执行
[2] 📝 调整计划
[3] 🔍 查看任务详情
[4] 🔄 调整模型分配
```

### Step 3: 任务执行（含模型选择）

```
💻 [开发者] 执行任务: I1 - 项目初始化

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 任务详情

目标: 初始化项目结构和基础配置
规模: S (小型)

## 🤖 自动模型选择

分析中...
- 任务类型: 模板化操作 → 强制 Haiku
- 预估代码: 30 行
- 涉及文件: 4 个
- 复杂度: 低

→ 选择模型: **Haiku** ✅
→ 预估成本: $

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 执行步骤

1. 创建目录结构
2. 初始化 package.json
3. 安装依赖
4. 配置 TypeScript
5. 配置 ESLint/Prettier

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

正在执行...

✅ 创建 src/routes/
✅ 创建 src/services/
✅ 创建 src/models/
...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

任务 I1 完成！

📝 已更新 .claude/TASKS.md:
   - I1 移动到 "已完成任务"
   - 添加会话日志: "完成 I1 项目初始化 (Haiku)"

[1] ▶️ 继续下一个任务
[2] 📋 查看变更
[3] 🔄 重做此任务
```

### Step 4: 代码审核

每个功能完成后自动触发:

```
👁️ [审核员] 代码审核

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 审核: F1 - 用户注册

### 代码质量
✅ 类型定义完整
✅ 错误处理正确
✅ 命名规范符合
⚠️ 缺少输入验证 (建议修复)

### 安全检查
✅ 密码正确哈希
✅ SQL 注入防护
✅ 无敏感信息泄露

### 测试覆盖
⚠️ 单元测试覆盖率: 60% (建议 > 80%)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

审核结果: ⚠️ 需要小修改

[1] 🔧 自动修复问题
[2] 📝 手动修改
[3] ⏭️ 跳过 (记录问题)
```

---

## 开发进度追踪

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚗 开发阶段进度
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

总进度: ████████████░░░░░░░░ 60%

基础设施: ████████████████████ 100% ✅
功能开发: ████████████░░░░░░░░ 60%
测试:     ░░░░░░░░░░░░░░░░░░░░ 0%

当前任务: F3 - 核心功能1
当前 Agent: 💻 开发者 (Sonnet)
下一任务: F4 - 核心功能2

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[✅ I1] [✅ I2] [✅ I3]
[✅ F1] [✅ F2] [🔄 F3] [⬜ F4]
[⬜ T1] [⬜ T2]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 阶段产出

### 代码文件

按照架构设计生成的所有代码文件。

### 更新 .claude/TASKS.md

开发阶段完成后，TASKS.md 最终状态:

```markdown
# [项目名称] - 任务追踪

> 创建于: [日期] | 阶段: 开发完成

## 当前状态

阶段: [✅ 研究] → [✅ 规划] → [✅ 架构] → [✅ 开发] → [⬜ 测试] → [⬜ 部署]
进度: ████████████████████ 100%
Agent: 💻 开发者

---

## 活跃任务

### 进行中

(无)

### 待处理

(无)

---

## 已完成任务

| ID | 任务 | 完成时间 | 耗时 | 产出 |
|----|------|----------|------|------|
| I1 | 项目初始化 | 12-23 14:00 | 10min | 目录结构 |
| I2 | 数据库配置 | 12-23 14:15 | 15min | db.ts |
| F1 | 用户注册 | 12-23 15:00 | 30min | auth/register.ts |
| F2 | 用户登录 | 12-23 15:30 | 25min | auth/login.ts |
| ... | ... | ... | ... | ... |

---

## 发现的问题

| ID | 问题描述 | 发现时间 | 状态 | 关联任务 |
|----|----------|----------|------|----------|
| #1 | 缺少输入验证 | 12-23 15:20 | ✅ 已修复 | F1 |

---

## 统计

- 总任务数: 8
- 已完成: 8
- 进行中: 0
- 待处理: 0
- 问题数: 1 (已修复)
```

### 更新 CLAUDE.md (仅重大事项)

```markdown
## Memory

### [日期] - 开发阶段完成
- **完成**: 所有功能开发、测试、代码审核
- **代码量**: [X] 文件, [Y] 行
- **测试覆盖**: [Z]%
- **详情**: 见 .claude/TASKS.md
```

---

## 开发阶段完成

```
✅ 开发阶段完成！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 完成统计

- 任务数: [Y] 个
- 代码行数: [Z] 行
- 代码审核: 通过

## 阶段进度

[✅ 研究] → [✅ 规划] → [✅ 架构] → [✅ 开发] → [🔄 测试] → [⬜ 部署]
                                              ↑
                                           下一步

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚦 进入 Gate 2 检查...

下一步：运行 /project-optimizer:gate 检查 Gate 2
```
