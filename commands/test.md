---
description: Testing phase - unit, integration, and e2e testing
---

# 测试阶段 (Phase 5/6)

代码测试、质量保证、覆盖率达标。

## 前置检查

读取 `.claude/PROJECT_STATE.json` 确认：
1. 开发阶段 (`dev`) 已完成
2. Gate 2 已通过
3. 当前阶段为 `test`

**如果未通过 Gate 2，拒绝执行：**
```
🚫 无法进入测试阶段

Gate 2 检查未通过。请先完成开发阶段并通过 Gate 2。

运行 /project-optimizer:gate 查看 Gate 2 检查清单
```

---

## Agent 配置

```
🧪 测试阶段 Agent 配置

## 主要 Agent
🧪 测试员 (QA Engineer)
- 模型: Sonnet
- 职责: 编写测试、执行测试、覆盖率检查

## 辅助 Agent
💻 开发者 (Developer)
- 模型: Sonnet
- 职责: 修复测试发现的 Bug
```

---

## 测试任务

### 🧪 1. 单元测试

```markdown
## 单元测试清单

### 测试框架配置
- [ ] 安装测试框架 (Jest/Vitest/Pytest 等)
- [ ] 配置测试环境
- [ ] 配置覆盖率工具

### 核心模块测试
- [ ] 工具函数测试
- [ ] 服务层测试
- [ ] 模型/数据验证测试

### 业务逻辑测试
- [ ] 用户认证逻辑
- [ ] 核心业务流程
- [ ] 边界条件处理

### 覆盖率目标
- 核心模块: ≥ 80%
- 业务逻辑: ≥ 70%
- 工具函数: ≥ 90%
```

### 🔗 2. 集成测试

```markdown
## 集成测试清单

### API 测试
- [ ] 认证接口测试
- [ ] 核心业务接口测试
- [ ] 错误处理测试

### 数据库测试
- [ ] CRUD 操作测试
- [ ] 事务测试
- [ ] 数据完整性测试

### 第三方服务测试
- [ ] Mock 外部服务
- [ ] 超时/重试测试
- [ ] 降级处理测试
```

### 🌐 3. 端到端测试 (E2E)

```markdown
## E2E 测试清单

### 用户流程测试
- [ ] 用户注册完整流程
- [ ] 用户登录完整流程
- [ ] 核心业务流程

### 浏览器兼容性 (Web 项目)
- [ ] Chrome
- [ ] Firefox
- [ ] Safari
- [ ] Edge

### 响应式测试 (Web 项目)
- [ ] 桌面端 (1920x1080)
- [ ] 平板 (768x1024)
- [ ] 移动端 (375x667)
```

### 🔒 4. 安全测试

```markdown
## 安全测试清单

### 认证安全
- [ ] 密码强度验证
- [ ] Token 安全性
- [ ] 会话管理

### 输入验证
- [ ] XSS 防护测试
- [ ] SQL 注入防护测试
- [ ] CSRF 防护测试

### 依赖安全
- [ ] npm audit / pip audit
- [ ] 依赖版本检查
- [ ] 已知漏洞扫描
```

### ⚡ 5. 性能测试

```markdown
## 性能测试清单

### 响应时间
- [ ] API 响应时间 < 200ms
- [ ] 页面加载时间 < 3s
- [ ] 数据库查询优化

### 负载测试
- [ ] 并发用户测试
- [ ] 压力测试
- [ ] 内存泄漏检测

### 资源优化
- [ ] 代码分割检查
- [ ] 图片优化检查
- [ ] 缓存策略检查
```

---

## 测试执行流程

### Step 1: 测试环境准备

```
🧪 [测试员] 准备测试环境

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

检测项目类型: [项目类型]
推荐测试框架: [框架名]

安装测试依赖:
- [x] 测试框架
- [x] 覆盖率工具
- [x] Mock 工具

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Step 2: 编写测试用例

```
🧪 [测试员] 编写测试用例

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

分析需要测试的模块...

## 测试用例计划

| 模块 | 测试类型 | 用例数 | 优先级 |
|------|----------|--------|--------|
| 认证模块 | 单元+集成 | 15 | P0 |
| 核心业务 | 单元+E2E | 20 | P0 |
| 工具函数 | 单元 | 10 | P1 |
| API接口 | 集成 | 12 | P0 |

请确认测试计划，或选择:
[1] ✅ 确认，开始编写测试
[2] ➕ 添加更多测试模块
[3] 🔧 调整测试优先级

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Step 3: 执行测试

```
🧪 [测试员] 执行测试

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

运行测试命令: npm run test

## 测试结果

单元测试: ✅ 45/45 通过
集成测试: ✅ 12/12 通过
E2E 测试: ⚠️ 8/10 通过

## 失败用例

| 测试 | 原因 | 严重程度 |
|------|------|----------|
| login.e2e.spec.ts | 超时 | P1 |
| checkout.e2e.spec.ts | 断言失败 | P0 |

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] 🔧 修复失败用例
[2] 📋 查看详细日志
[3] ⏭️ 标记为已知问题，继续
```

### Step 4: 覆盖率检查

```
📊 [测试员] 覆盖率报告

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 覆盖率统计

| 类型 | 当前 | 目标 | 状态 |
|------|------|------|------|
| 语句覆盖 | 82% | 80% | ✅ |
| 分支覆盖 | 75% | 70% | ✅ |
| 函数覆盖 | 88% | 80% | ✅ |
| 行覆盖 | 81% | 80% | ✅ |

## 未覆盖模块

| 文件 | 覆盖率 | 建议 |
|------|--------|------|
| src/utils/legacy.ts | 45% | 补充测试 |
| src/services/export.ts | 60% | 补充测试 |

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] 📝 补充低覆盖率模块测试
[2] ✅ 覆盖率达标，继续
[3] 📋 生成覆盖率报告
```

---

## 测试完成标准

| 检查项 | 目标 | 状态 |
|--------|------|------|
| 单元测试通过率 | 100% | ⬜ |
| 集成测试通过率 | 100% | ⬜ |
| E2E 测试通过率 | ≥ 95% | ⬜ |
| 代码覆盖率 | ≥ 80% | ⬜ |
| 无 P0 Bug | 0 个 | ⬜ |
| 安全扫描通过 | 通过 | ⬜ |

---

## 阶段完成

更新 `PROJECT_STATE.json`:
```json
{
  "phases": {
    "test": { "status": "completed", "completedAt": "[timestamp]" },
    "deploy": { "status": "in_progress", "completedAt": null }
  },
  "currentPhase": "deploy"
}
```

更新 `.claude/TASKS.md`:
```markdown
## 测试阶段完成

- 单元测试: X/X 通过
- 集成测试: X/X 通过
- E2E 测试: X/X 通过
- 覆盖率: XX%
```

输出：
```
✅ 测试阶段完成！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

已完成：
✓ 单元测试 (45 个用例)
✓ 集成测试 (12 个用例)
✓ E2E 测试 (10 个用例)
✓ 覆盖率达标 (82%)
✓ 安全扫描通过

📄 测试报告: docs/TEST_REPORT.md

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[✅ 研究] → [✅ 规划] → [✅ 架构] → [✅ 开发] → [✅ 测试] → [🔄 部署]
                                                              ↑
                                                           下一步

🚦 进入 Gate 3 检查...

下一步：运行 /project-optimizer:gate 检查 Gate 3
```

---

## 注意事项

1. **测试优先级** - P0 Bug 必须修复才能进入部署阶段
2. **覆盖率要求** - 核心模块覆盖率必须 ≥ 80%
3. **安全检查** - 安全扫描必须通过
4. **测试报告** - 生成完整的测试报告供审查
