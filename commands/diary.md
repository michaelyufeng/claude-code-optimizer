---
description: Short-term memory - capture session info to .claude/TASKS.md
---

# 短期记忆 (Diary)

记录会话关键信息到 `.claude/TASKS.md` 的会话日志区域。

**重要变更**: 不再写入 CLAUDE.md，改为独立的任务追踪文件。

## 自动驾驶行为

自动驾驶模式下，diary 会在以下时机自动触发：

- 重要决策后
- 阶段完成后
- 每个功能完成后
- 遇到关键问题时
- **用户手动修改代码后** (自动检测)

---

## 写入位置

| 内容类型 | 写入位置 | 说明 |
|----------|----------|------|
| 任务状态变更 | `.claude/TASKS.md` 活跃任务 | 任务开始/完成 |
| 会话日志 | `.claude/TASKS.md` 会话日志 | 时间线记录 |
| 发现的问题 | `.claude/TASKS.md` 发现的问题 | Bug/待优化项 |
| 重大决策 | `CLAUDE.md` Memory | 仅影响全局的决策 |

---

## 会话日志格式

写入 `.claude/TASKS.md` 的 `## 会话日志` 区域：

```markdown
## 会话日志

### 2024-12-23

- **15:30** - 完成 F1 用户注册功能
- **15:00** - 决定使用 JWT 认证 (原因: 无状态、易扩展)
- **14:30** - 发现问题 #1: 缺少输入验证
- **14:00** - 开始 F1 任务

### 2024-12-22
...
```

---

## 自动记录内容

### 任务状态变更

当任务状态变化时，更新 `.claude/TASKS.md`:

**开始任务时:**
```markdown
## 活跃任务

### 进行中

| ID | 任务 | Agent | 开始时间 | 备注 |
|----|------|-------|----------|------|
| F1 | 用户注册 | 💻 开发者 | 15:00 | 新增 |
```

**完成任务时:**
```markdown
## 已完成任务

| ID | 任务 | 完成时间 | 耗时 | 产出 |
|----|------|----------|------|------|
| F1 | 用户注册 | 15:30 | 30min | src/auth/register.ts |
```

### 发现问题时

添加到 `.claude/TASKS.md` 的问题区域:

```markdown
## 发现的问题

| ID | 问题描述 | 发现时间 | 状态 | 关联任务 |
|----|----------|----------|------|----------|
| #1 | 缺少输入验证 | 15:20 | 待处理 | F1 |
| #2 | N+1 查询问题 | 16:00 | 已修复 | F3 |
```

### 阶段完成时

更新状态并添加日志:

```markdown
## 当前状态

阶段: [✅ 研究] → [🔄 规划] → [⬜ 架构] → [⬜ 开发]
进度: ████████░░░░░░░░░░░░ 40%
Agent: 📋 PM

## 会话日志

### 2024-12-23

- **16:00** - ✅ 研究阶段完成，通过 Gate 1
- **16:05** - 进入规划阶段，Agent 切换为 📋 PM
```

---

## 日志容量管理

### 会话日志保留策略

```markdown
## 容量规则

- 当天日志: 完整保留
- 7 天内日志: 保留关键事件
- 7 天以上: 自动 reflect 到 docs/HISTORY.md
```

### 自动触发 reflect

```
📝 会话日志超过 7 天

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

正在整理旧日志到长期记忆...

将归档到 docs/HISTORY.md:
- 12-16 ~ 12-20 的日志 (23 条)

保留在 TASKS.md:
- 12-21 ~ 12-23 的日志 (15 条)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

归档完成！
```

---

## 手动命令

```bash
/project-optimizer:diary                    # 自动分析并记录到 TASKS.md
/project-optimizer:diary "完成了XX功能"      # 指定记录内容
/project-optimizer:diary --show             # 查看当前任务和日志
/project-optimizer:diary --tasks            # 仅查看任务状态
/project-optimizer:diary --log              # 仅查看会话日志
```

### 手动记录示例

```
/project-optimizer:diary "决定使用 JWT 认证"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 已记录到 .claude/TASKS.md

## 会话日志

### 2024-12-23

- **16:00** - 决定使用 JWT 认证 (原因: 无状态、易扩展)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 查看任务状态

```
/project-optimizer:diary --show

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 任务追踪 (.claude/TASKS.md)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 当前状态

阶段: [✅ 研究] → [✅ 规划] → [🔄 架构] → [⬜ 开发]
进度: ████████████░░░░░░░░ 60%
Agent: 🏗️ 架构师

## 活跃任务

| ID | 任务 | Agent | 状态 |
|----|------|-------|------|
| A2 | API 设计 | 🏗️ 架构师 | 进行中 |

## 今日日志 (5 条)

- **16:00** - 决定使用 JWT 认证
- **15:30** - 完成 A1 数据模型设计
- **15:00** - 开始架构阶段
- **14:30** - 通过 Gate 2
- **14:00** - 规划阶段完成

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] 📖 查看完整 TASKS.md
[2] 🔄 整理到长期记忆
[3] ➕ 添加新任务
[4] ✅ 标记任务完成
```

---

## 与其他系统集成

### 文件职责分离

| 文件 | 职责 | 更新频率 |
|------|------|----------|
| `.claude/TASKS.md` | 任务状态、会话日志 | 实时 |
| `.claude/PROJECT_STATE.json` | 阶段状态、Agent | 阶段变更时 |
| `CLAUDE.md` | 项目规则、技术栈、重大决策 | 较少 |
| `docs/HISTORY.md` | 长期记忆归档 | reflect 时 |

### 自动同步保证

- **新会话**: 读取 `.claude/TASKS.md` 恢复上下文
- **Git commit**: 自动提交 TASKS.md 变更
- **跨会话**: 任务状态完整保留
