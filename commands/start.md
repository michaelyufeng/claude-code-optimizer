---
description: Auto-pilot mode - one command to drive the entire project
---

# 自动驾驶模式 (Auto-Pilot)

一次启动，全程跟踪项目直到完成。

## 启动命令

```bash
/project-optimizer:start [项目描述]
/project-optimizer:start --resume    # 恢复已有项目
```

## 核心机制

### 1. 全自动 4 阶段流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  研究    │───▶│  规划    │───▶│  架构    │───▶│  开发    │
│ Research │    │   Plan   │    │   Arch   │    │   Dev    │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘
     │               │               │               │
     ▼               ▼               ▼               ▼
  [Gate 1]       [Gate 2]       [Gate 3]       [完成]
```

### 2. 选项驱动（禁止无方向编码）

每个决策点都会提供选项，Claude 不会无方向地编写代码。

### 3. 自动 Agent 分配

根据任务类型自动分配最合适的 Agent 和模型。

### 4. 双记忆系统

- 短期记忆：Memory 区域（最近 10 条）
- 长期记忆：History 文件（永久保存）

---

## 启动流程

### Step 1: 项目初始化

```
🚀 自动驾驶模式启动

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 项目信息收集

项目名称: $ARGUMENTS 或询问用户
项目类型: [自动检测或询问]

请选择项目类型:
[1] 🌐 Web 应用 (前端/全栈)
[2] 🔧 API 服务 (后端)
[3] 📱 移动应用
[4] 🛠️ CLI 工具
[5] 📦 库/SDK
[6] 🤖 其他

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Step 2: 创建项目文件

#### 2.1 创建 `.claude/PROJECT_STATE.json`:

```json
{
  "project": {
    "name": "[项目名称]",
    "type": "[项目类型]",
    "description": "[项目描述]",
    "createdAt": "[timestamp]"
  },
  "autopilot": {
    "enabled": true,
    "startedAt": "[timestamp]",
    "currentPhase": "research",
    "phaseProgress": 0
  },
  "phases": {
    "research": { "status": "in_progress", "gate": null },
    "plan": { "status": "pending", "gate": null },
    "arch": { "status": "pending", "gate": null },
    "dev": { "status": "pending", "gate": null }
  },
  "agents": {
    "active": "analyst",
    "history": []
  }
}
```

#### 2.2 创建 `.claude/TASKS.md` (独立任务追踪):

```markdown
# [项目名称] - 任务追踪

> 创建于: [日期] | 阶段: 研究

## 当前状态

阶段: [🔄 研究] → [⬜ 规划] → [⬜ 架构] → [⬜ 开发]
进度: ██░░░░░░░░░░░░░░░░░░ 10%
Agent: 🔬 分析师

---

## 活跃任务

### 进行中

| ID | 任务 | Agent | 开始时间 | 备注 |
|----|------|-------|----------|------|
| R1 | 需求分析 | 🔬 分析师 | [时间] | 研究阶段 |

### 待处理

| ID | 任务 | 优先级 | 依赖 | 预估规模 |
|----|------|--------|------|----------|
| R2 | 技术可行性 | P0 | R1 | S |
| R3 | 竞品研究 | P1 | - | S |

---

## 已完成任务

| ID | 任务 | 完成时间 | 耗时 | 产出 |
|----|------|----------|------|------|
| - | - | - | - | - |

---

## 发现的问题

| ID | 问题描述 | 发现时间 | 状态 | 关联任务 |
|----|----------|----------|------|----------|
| - | - | - | - | - |

---

## 会话日志

### [日期]

- **[时间]** - 项目初始化，启动自动驾驶
- **[时间]** - 进入研究阶段

---

## 统计

- 总任务数: 3
- 已完成: 0
- 进行中: 1
- 待处理: 2
- 问题数: 0
```

**重要**: 任务状态现在独立保存在 `.claude/TASKS.md`，不再写入 CLAUDE.md 的 Memory 区域。

#### 2.3 创建 `.claude/LAST_SYNC.json` (同步追踪):

```json
{
  "version": "1.0",
  "lastSyncAt": "[timestamp]",
  "lastCommit": "[当前 commit hash]",
  "currentPhase": "research",
  "trackedFiles": {
    "files": []
  },
  "taskSnapshot": {
    "completed": [],
    "inProgress": ["R1"],
    "pending": ["R2", "R3"]
  },
  "userChanges": {
    "history": []
  },
  "syncHistory": {
    "records": [
      {
        "syncAt": "[timestamp]",
        "type": "initial",
        "changes": 0,
        "description": "项目初始化"
      }
    ]
  }
}
```

**用途**: 追踪同步状态，检测用户离线变更。

### Step 3: 自动进入研究阶段

```
✅ 项目初始化完成！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚗 自动驾驶已启动

当前阶段: 🔬 研究阶段 (1/4)
当前 Agent: 🔬 分析师

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔬 [分析师] 开始研究...

我将分析以下内容:
1. 项目需求和目标用户
2. 技术可行性
3. 类似项目/竞品
4. 推荐技术方案

请描述你的项目需求，或选择:
[1] 📝 详细描述需求
[2] 📎 上传需求文档
[3] 🔍 让我分析现有代码

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 自动驾驶行为规则

### 阶段自动推进

```markdown
## 自动推进条件

1. 当前阶段完成所有必要任务
2. Gate 检查通过
3. 用户确认（关键节点）

## 自动推进流程

阶段完成 → Gate 检查 → 通过 → 自动进入下一阶段
                      → 失败 → 显示问题 → 修复后重试
```

### Agent 自动切换

```markdown
## Agent 自动分配

| 阶段 | 主要 Agent | 辅助 Agent |
|------|-----------|-----------|
| 研究 | 🔬 分析师 | - |
| 规划 | 📋 PM | 🔬 分析师 |
| 架构 | 🏗️ 架构师 | 📋 PM |
| 开发 | 💻 开发者 | 👁️ 审核员 |

## 任务级别 Agent

| 任务类型 | Agent | 模型 |
|----------|-------|------|
| 简单实现 | 💻 开发者 | Haiku |
| 复杂逻辑 | 💻 开发者 | Sonnet |
| 架构决策 | 🏗️ 架构师 | Opus |
| 代码审查 | 👁️ 审核员 | Sonnet |
```

### 任务自动分割

```markdown
## 大任务自动分割

检测条件:
- 预估代码 > 200 行
- 涉及文件 > 3 个
- 有多个独立子功能

分割后:
- 自动创建子任务
- 分配给合适的 Agent
- 可并行的任务同时执行
```

---

## 全程同步机制

### CLAUDE.md 自动更新

```markdown
## 同步触发点

1. 阶段完成时
   → 自动更新项目状态
   → 添加阶段产出摘要

2. 重要决策时
   → 记录到 Memory
   → 更新规则（如有）

3. 代码变更时
   → 检测结构变化
   → 更新技术栈信息

4. Git commit 时
   → 自动归档短期记忆
   → 更新变更历史
```

### 双记忆自动管理

```markdown
## 短期记忆 (Memory)

- 自动记录关键决策
- 最多保留 10 条
- 超出时自动 reflect 到长期记忆

## 长期记忆 (History)

- reflect 命令整理
- 永久保存在 docs/HISTORY.md
- 按时间和主题组织
```

---

## 输出格式

### 阶段进度显示

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚗 自动驾驶状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

进度: ████████░░░░░░░░░░░░ 40%

[✅ 研究] → [✅ 规划] → [🔄 架构] → [⬜ 开发]
                           ↑
                        当前阶段

当前任务: 设计 API 接口
当前 Agent: 🏗️ 架构师
下一步: 完成 API 设计后进入 Gate 3

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 选项提示格式

```
📋 [阶段名] 需要决策

[问题描述]

请选择:
[1] [选项1] (推荐) - [说明]
[2] [选项2] - [说明]
[3] [选项3] - [说明]
[4] 🔍 需要更多信息

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 恢复模式

```bash
/project-optimizer:start --resume
```

### Step 1: 加载项目状态

```
🔄 恢复自动驾驶模式

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 检测到项目状态

项目: [项目名称]
上次活动: [时间]
当前阶段: [阶段]
进度: [百分比]

最近任务: (从 .claude/TASKS.md 读取)
- [进行中任务]
- [最近完成任务]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Step 2: 自动检测变更 (关键!)

**恢复时自动执行变更检测:**

```
🔍 检测离线变更...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

读取: .claude/LAST_SYNC.json
执行: git diff [lastCommit]..HEAD
执行: git status --porcelain

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**情况 A: 无变更**

```
✅ 无离线变更

上次同步: 2 小时前
代码状态: 与任务追踪一致

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] ▶️ 继续当前任务
[2] 📋 查看完整状态
[3] 🔄 重新开始当前阶段
```

**情况 B: 检测到变更**

```
⚠️ 检测到离线变更！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

上次同步后发生的变更:

## 已追踪任务相关

| 文件 | 变更 | 关联任务 | 任务状态 |
|------|------|----------|----------|
| src/auth/login.ts | 修改 | F2 | 进行中 |

## 未追踪变更 (用户手动修改)

| 文件 | 变更 | 时间 |
|------|------|------|
| src/utils/helper.ts | 新增 | 1 小时前 |
| src/config.ts | 修改 | 30 分钟前 |

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

这些变更未被任务系统追踪，需要同步吗？

[1] 🔄 同步到任务系统 (推荐)
    → 自动关联或创建任务
[2] ➕ 手动创建任务
    → 为这些变更创建新任务
[3] ⏭️ 跳过同步
    → 记录但不处理，继续工作
[4] 📋 查看变更详情
    → 查看具体改动内容
```

### Step 3: 同步处理

选择 [1] 同步后:

```
🔄 同步变更中...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 同步结果

✅ src/auth/login.ts
   → 关联到 F2 (用户登录)
   → 更新 F2 备注: "用户手动修改"

✅ src/utils/helper.ts
   → 创建任务 U1 (工具函数)
   → 状态: 已完成

✅ src/config.ts
   → 关联到 I1 (项目配置)
   → 更新 I1 备注: "配置优化"

## 已更新文件

📝 .claude/TASKS.md - 添加 U1，更新 F2、I1 备注
📝 .claude/LAST_SYNC.json - 更新同步点

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

同步完成！

[1] ▶️ 继续当前任务 (F2)
[2] 📋 查看更新后的任务列表
```

### Step 4: 继续工作

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚗 自动驾驶已恢复

当前阶段: 🔧 开发阶段 (3/4)
当前任务: F2 - 用户登录
当前 Agent: 💻 开发者

上次进度: 登录 API 实现中
用户变更: 已同步 (3 个文件)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

继续 F2 任务...
```

---

## 注意事项

1. **不可跳过阶段** - 必须按顺序完成 4 个阶段
2. **不可跳过 Gate** - 每个阶段必须通过门控检查
3. **禁止无方向编码** - 所有编码必须有明确的任务来源
4. **强制选项驱动** - 关键决策必须由用户选择
5. **自动同步** - CLAUDE.md 和项目状态实时同步
