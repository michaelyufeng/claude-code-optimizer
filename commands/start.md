---
description: Auto-pilot mode - one command to drive the entire project
---

# 自动驾驶模式 (Auto-Pilot)

一次启动，全程跟踪项目直到完成。

## 启动命令

```bash
/project-optimizer:start [项目描述]         # 新项目（默认完整流程）
/project-optimizer:start --resume           # 恢复已有项目
/project-optimizer:start --phase [阶段]     # 从指定阶段开始
/project-optimizer:start --type [类型]      # 指定项目类型预设
```

### 参数说明

**--phase** 阶段跳转（适用于已有项目）:
- `research` - 从研究阶段开始
- `plan` - 从规划阶段开始
- `arch` - 从架构阶段开始
- `dev` - 从开发阶段开始
- `test` - 从测试阶段开始
- `deploy` - 从部署阶段开始

**--type** 项目类型预设:
- `new` - 新项目，完整 6 阶段流程
- `existing` - 已有项目，从架构阶段开始
- `maintenance` - 维护项目，从开发阶段开始

## 核心机制

### 1. 6 阶段流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  研究    │───▶│  规划    │───▶│  架构    │───▶│  开发    │───▶│  测试    │───▶│  部署    │
│ Research │    │   Plan   │    │   Arch   │    │   Dev    │    │   Test   │    │  Deploy  │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘    └──────────┘
     │               │               │               │               │
     ▼               ▼               │               ▼               ▼
                 [Gate 1]            │           [Gate 2]        [Gate 3]
```

**Gate 1** (规划→架构): PRD 完整性检查
**Gate 2** (开发→测试): 代码质量检查
**Gate 3** (测试→部署): 测试覆盖率检查

### 2. 选项驱动（禁止无方向编码）

每个决策点都会提供选项，Claude 不会无方向地编写代码。

### 3. 自动 Agent 分配

根据任务类型自动分配最合适的 Agent 和模型。

### 4. 双记忆系统

- 短期记忆：Memory 区域（最近 10 条）
- 长期记忆：History 文件（永久保存）

---

## 启动流程

### Step 1: 解析参数

```
🚀 自动驾驶模式启动

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

检测启动参数...

参数: $ARGUMENTS
```

**处理逻辑:**

1. 如果包含 `--resume`:
   → 执行恢复流程（见下方恢复模式）

2. 如果包含 `--phase [阶段]`:
   → 跳过前置阶段，直接进入指定阶段
   → 提示用户确认（跳过的阶段产出需手动准备）

3. 如果包含 `--type [类型]`:
   - `new` → 完整 6 阶段
   - `existing` → 从架构开始
   - `maintenance` → 从开发开始

4. 无参数或仅有项目描述:
   → 询问项目类型，执行完整流程

### Step 2: 项目初始化

```
📋 项目信息收集

项目名称: $ARGUMENTS 或询问用户
项目类型: [自动检测或询问]

请选择项目类型:
[1] 🌐 Web 应用 (前端/全栈)
[2] 🔧 API 服务 (后端)
[3] 📱 移动应用
[4] 🛠️ CLI 工具
[5] 📦 库/SDK
[6] 🤖 其他

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Step 3: 创建项目文件

#### 3.1 创建 `.claude/PROJECT_STATE.json`:

```json
{
  "project": {
    "name": "[项目名称]",
    "type": "[项目类型]",
    "description": "[项目描述]",
    "createdAt": "[timestamp]"
  },
  "autopilot": {
    "enabled": true,
    "startedAt": "[timestamp]",
    "currentPhase": "[起始阶段]",
    "phaseProgress": 0
  },
  "phases": {
    "research": { "status": "[状态]", "gate": null },
    "plan": { "status": "[状态]", "gate": null },
    "arch": { "status": "[状态]", "gate": null },
    "dev": { "status": "[状态]", "gate": null },
    "test": { "status": "[状态]", "gate": null },
    "deploy": { "status": "[状态]", "gate": null }
  },
  "agents": {
    "active": "[当前Agent]",
    "history": []
  }
}
```

**状态根据 --phase 或 --type 设置:**
- 跳过的阶段: `"status": "skipped"`
- 当前阶段: `"status": "in_progress"`
- 后续阶段: `"status": "pending"`

#### 3.2 创建 `.claude/TASKS.md` (独立任务追踪):

```markdown
# [项目名称] - 任务追踪

> 创建于: [日期] | 阶段: [起始阶段]

## 当前状态

阶段: [阶段进度条]
进度: [百分比]
Agent: [当前Agent]

---

## 活跃任务

### 进行中

| ID | 任务 | Agent | 开始时间 | 备注 |
|----|------|-------|----------|------|

### 待处理

| ID | 任务 | 优先级 | 依赖 | 预估规模 |
|----|------|--------|------|----------|

---

## 已完成任务

| ID | 任务 | 完成时间 | 耗时 | 产出 |
|----|------|----------|------|------|

---

## 会话日志

### [日期]

- **[时间]** - 项目初始化

---

## 统计

- 总任务数: 0
- 已完成: 0
- 进行中: 0
- 待处理: 0
```

#### 3.3 创建 `.claude/LAST_SYNC.json` (同步追踪):

```json
{
  "version": "1.0",
  "lastSyncAt": "[timestamp]",
  "lastCommit": "[当前 commit hash]",
  "currentPhase": "[起始阶段]",
  "trackedFiles": {
    "files": []
  },
  "taskSnapshot": {
    "completed": [],
    "inProgress": [],
    "pending": []
  },
  "userChanges": {
    "history": []
  },
  "syncHistory": {
    "records": [
      {
        "syncAt": "[timestamp]",
        "type": "initial",
        "changes": 0,
        "description": "项目初始化"
      }
    ]
  }
}
```

### Step 4: 进入起始阶段

```
✅ 项目初始化完成！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚗 自动驾驶已启动

当前阶段: [阶段图标] [阶段名] ([n]/6)
当前 Agent: [Agent图标] [Agent名]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[根据阶段显示对应的引导信息]
```

---

## 阶段流程与 Agent 分配

### 阶段概览

| 阶段 | 主 Agent | 辅助 Agent | 前置 Gate |
|------|----------|------------|-----------|
| 研究 | 🔬 分析师 | - | - |
| 规划 | 📋 PM | 🔬 分析师 | - |
| 架构 | 🏗️ 架构师 | 📋 PM | Gate 1 |
| 开发 | 💻 开发者 | 👁️ 审核员 | - |
| 测试 | 🧪 测试员 | 💻 开发者 | Gate 2 |
| 部署 | 🚀 运维 | 💻 开发者 | Gate 3 |

### 任务级别模型分配

| 任务规模 | 代码行数 | 模型 |
|----------|----------|------|
| S (小) | <50 | Haiku |
| M (中) | 50-200 | Sonnet |
| L (大) | 200-500 | Sonnet |
| XL (超大) | >500 | Opus |

---

## 恢复模式

```bash
/project-optimizer:start --resume
/project-optimizer:start --resume --phase [阶段]  # 恢复后跳到指定阶段
```

### Step 1: 加载项目状态

```
🔄 恢复自动驾驶模式

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 检测到项目状态

项目: [项目名称]
上次活动: [时间]
当前阶段: [阶段]
进度: [百分比]

最近任务: (从 .claude/TASKS.md 读取)
- [进行中任务]
- [最近完成任务]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Step 2: 自动检测变更

```
🔍 检测离线变更...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

读取: .claude/LAST_SYNC.json
执行: git diff [lastCommit]..HEAD
执行: git status --porcelain
```

**情况 A: 无变更**

```
✅ 无离线变更

上次同步: [时间]
代码状态: 与任务追踪一致

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] ▶️ 继续当前任务
[2] 📋 查看完整状态
[3] 🔄 重新开始当前阶段
```

**情况 B: 检测到变更**

```
⚠️ 检测到离线变更！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

上次同步后发生的变更:

## 已追踪任务相关

| 文件 | 变更 | 关联任务 | 任务状态 |
|------|------|----------|----------|

## 未追踪变更

| 文件 | 变更 | 时间 |
|------|------|------|

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] 🔄 同步到任务系统 (推荐)
[2] ➕ 手动创建任务
[3] ⏭️ 跳过同步
[4] 📋 查看变更详情
```

### Step 3: 继续工作

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚗 自动驾驶已恢复

当前阶段: [阶段图标] [阶段名]
当前任务: [任务ID] - [任务名]
当前 Agent: [Agent图标] [Agent名]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

继续任务...
```

---

## 输出格式

### 阶段进度显示

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚗 自动驾驶状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

进度: ████████░░░░░░░░░░░░ 40%

[✅ 研究] → [✅ 规划] → [🔄 架构] → [⬜ 开发] → [⬜ 测试] → [⬜ 部署]
                          ↑
                       当前阶段

当前任务: [任务描述]
当前 Agent: [Agent图标] [Agent名]
下一步: [下一步描述]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 选项提示格式

```
📋 [阶段名] 需要决策

[问题描述]

请选择:
[1] [选项1] (推荐) - [说明]
[2] [选项2] - [说明]
[3] [选项3] - [说明]
[4] 🔍 需要更多信息

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 阶段跳转确认

使用 `--phase` 或 `--type existing/maintenance` 时:

```
⚠️ 阶段跳转确认

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

你选择从 [阶段] 开始，将跳过以下阶段:
- ⏭️ 研究阶段
- ⏭️ 规划阶段

跳过的阶段产出需要你手动准备:
- docs/PRD.md (产品需求文档)
- docs/RESEARCH.md (研究报告)

[1] ✅ 确认跳过（已准备好文档）
[2] 🔍 检测现有文档
[3] ❌ 取消，从头开始
```

---

## 注意事项

1. **灵活的阶段进入** - 可通过 --phase 或 --type 跳过前置阶段
2. **Gate 强制检查** - Gate 1/2/3 必须通过才能进入下一阶段
3. **禁止无方向编码** - 所有编码必须有明确的任务来源
4. **强制选项驱动** - 关键决策必须由用户选择
5. **自动同步** - 项目状态实时同步
