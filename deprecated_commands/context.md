---
description: Context and token management - optimize token usage for large codebases
---

# ä¸Šä¸‹æ–‡ç®¡ç† (Context Management)

## åŠŸèƒ½è¯´æ˜

æ™ºèƒ½ç®¡ç†ä¸Šä¸‹æ–‡çª—å£ï¼Œä¼˜åŒ– Token ä½¿ç”¨ï¼Œæ”¯æŒå¤§å‹ä»£ç åº“ã€‚

## ä¸Šä¸‹æ–‡é™åˆ¶

| æ¨¡å‹ | ä¸Šä¸‹æ–‡çª—å£ | è¾“å‡ºé™åˆ¶ |
|------|------------|----------|
| Haiku | 200K | 8K |
| Sonnet | 200K | 16K |
| Opus | 200K | 32K |

## ä½¿ç”¨æ–¹æ³•

### 1. æŸ¥çœ‹å½“å‰ä¸Šä¸‹æ–‡çŠ¶æ€

```
/project-optimizer:context
```

è¾“å‡ºï¼š
```
ğŸ“Š ä¸Šä¸‹æ–‡çŠ¶æ€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Token ä½¿ç”¨æƒ…å†µ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40%   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å·²ä½¿ç”¨: 80,000 / 200,000 tokens

æ„æˆåˆ†æ:
- ç³»ç»Ÿæç¤º: 5,000 (2.5%)
- CLAUDE.md: 2,000 (1%)
- å¯¹è¯å†å²: 30,000 (15%)
- å·²åŠ è½½æ–‡ä»¶: 40,000 (20%)
- å‰©ä½™ç©ºé—´: 123,000 (61.5%)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å·²åŠ è½½æ–‡ä»¶:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–‡ä»¶                   â”‚ Tokens â”‚ ä¼˜å…ˆçº§   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ src/components/App.tsx â”‚ 15,000 â”‚ é«˜       â”‚
â”‚ src/api/auth.ts        â”‚ 10,000 â”‚ é«˜       â”‚
â”‚ src/utils/helpers.ts   â”‚ 8,000  â”‚ ä¸­       â”‚
â”‚ src/types/index.ts     â”‚ 7,000  â”‚ ä½       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å»ºè®®:
âš ï¸ å¯¹è¯å†å²è¾ƒé•¿ï¼Œè€ƒè™‘ä½¿ç”¨ /compact å‹ç¼©
```

### 2. æ¸…ç†ä¸Šä¸‹æ–‡

```
/project-optimizer:context-clean
```

æ¸…ç†ç­–ç•¥ï¼š
```markdown
## æ¸…ç†ç­–ç•¥

### è‡ªåŠ¨æ¸…ç† (Auto)
- ç§»é™¤å·²å®Œæˆä»»åŠ¡çš„ç›¸å…³ä¸Šä¸‹æ–‡
- å‹ç¼©é‡å¤ä¿¡æ¯
- ç§»é™¤ä½ä¼˜å…ˆçº§æ–‡ä»¶

### æ‰‹åŠ¨æ¸…ç† (Manual)
- `/project-optimizer:unload [file]` - å¸è½½æŒ‡å®šæ–‡ä»¶
- `/project-optimizer:compact` - å‹ç¼©å¯¹è¯å†å²
- `/project-optimizer:reset-context` - é‡ç½®ä¸Šä¸‹æ–‡ï¼ˆä¿ç•™å…³é”®ä¿¡æ¯ï¼‰
```

### 3. é¢„åŠ è½½æ–‡ä»¶

```
/project-optimizer:preload [pattern]
```

ç¤ºä¾‹ï¼š
```
/project-optimizer:preload src/components/*.tsx
```

è¾“å‡ºï¼š
```
ğŸ“‚ é¢„åŠ è½½æ–‡ä»¶

åŒ¹é…çš„æ–‡ä»¶:
- src/components/Header.tsx (2,500 tokens)
- src/components/Footer.tsx (1,500 tokens)
- src/components/Sidebar.tsx (3,000 tokens)
- src/components/Modal.tsx (2,000 tokens)

æ€»è®¡: 9,000 tokens
å½“å‰å‰©ä½™: 123,000 tokens
åŠ è½½åå‰©ä½™: 114,000 tokens

ç¡®è®¤åŠ è½½ï¼Ÿ(y/n)
```

---

## åˆ†ç‰‡åŠ è½½ç­–ç•¥ (Document Sharding)

å¯¹äºå¤§å‹æ–‡ä»¶ï¼Œä½¿ç”¨åˆ†ç‰‡åŠ è½½ï¼š

### ç­–ç•¥è¯´æ˜

```markdown
## åˆ†ç‰‡ç­–ç•¥

### æŒ‰åŠŸèƒ½åˆ†ç‰‡
- åªåŠ è½½å½“å‰ä»»åŠ¡éœ€è¦çš„å‡½æ•°/ç±»
- ä½¿ç”¨ AST è§£ææå–ç›¸å…³ä»£ç æ®µ

### æŒ‰ä¾èµ–åˆ†ç‰‡
- ä»å…¥å£æ–‡ä»¶å¼€å§‹
- æŒ‰ä¾èµ–é“¾åŠ è½½å¿…è¦æ–‡ä»¶
- è·³è¿‡æœªä½¿ç”¨çš„æ¨¡å—

### æŒ‰ä¼˜å…ˆçº§åˆ†ç‰‡
- P0: å½“å‰ä¿®æ”¹çš„æ–‡ä»¶
- P1: ç›´æ¥ä¾èµ–çš„æ–‡ä»¶
- P2: é—´æ¥ä¾èµ–çš„æ–‡ä»¶
- P3: å‚è€ƒæ–‡ä»¶ï¼ˆå¯å»¶è¿ŸåŠ è½½ï¼‰
```

### ä½¿ç”¨æ–¹æ³•

```
/project-optimizer:shard [file] [function/class]
```

ç¤ºä¾‹ï¼š
```
/project-optimizer:shard src/services/userService.ts getUserById
```

è¾“å‡ºï¼š
```
ğŸ”ª åˆ†ç‰‡åŠ è½½

ç›®æ ‡: src/services/userService.ts::getUserById

æå–å†…å®¹:
- getUserById å‡½æ•° (50 è¡Œ)
- ç›¸å…³ç±»å‹å®šä¹‰ (20 è¡Œ)
- å¯¼å…¥ä¾èµ– (10 è¡Œ)

åŸå§‹æ–‡ä»¶: 500 è¡Œ (~10,000 tokens)
åˆ†ç‰‡å: 80 è¡Œ (~1,600 tokens)
èŠ‚çœ: 84%
```

---

## ä¸Šä¸‹æ–‡ä¼˜åŒ–å»ºè®®

### å¤§å‹é¡¹ç›®ç­–ç•¥

```markdown
## æ¨èé…ç½®

### åˆ†å±‚ CLAUDE.md
- æ ¹ç›®å½•: å…¨å±€é…ç½® (ç²¾ç®€)
- å­æ¨¡å—: æ¨¡å—ç‰¹å®šé…ç½®
- åªåœ¨éœ€è¦æ—¶åŠ è½½å­æ¨¡å—é…ç½®

### æŒ‰éœ€åŠ è½½
- ä¸é¢„åŠ è½½æ‰€æœ‰æ–‡ä»¶
- ä½¿ç”¨æœç´¢å®šä½åå†åŠ è½½
- å®ŒæˆååŠæ—¶å¸è½½

### å¯¹è¯ç®¡ç†
- å®šæœŸå‹ç¼©å¯¹è¯å†å²
- ä½¿ç”¨ checkpoint ä¿å­˜è¿›åº¦
- æ–°ä»»åŠ¡è€ƒè™‘æ–°ä¼šè¯
```

### Token é¢„ç®—åˆ†é…

```markdown
## æ¨èé¢„ç®—åˆ†é…

æ€»é¢„ç®—: 200K tokens

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿ/é…ç½®: 10K (5%)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¥ä½œä»£ç : 100K (50%)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯¹è¯å†å²: 50K (25%)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å‡ºç¼“å†²: 40K (20%)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é…ç½®æ–‡ä»¶

åˆ›å»º `.claude/CONTEXT.json`:

```json
{
  "strategy": "auto",
  "maxTokens": 200000,
  "budgetAllocation": {
    "system": 0.05,
    "workingCode": 0.50,
    "conversation": 0.25,
    "outputBuffer": 0.20
  },
  "autoClean": {
    "enabled": true,
    "threshold": 0.80,
    "keepPriority": ["high", "medium"]
  },
  "preloadPatterns": [
    "CLAUDE.md",
    "src/index.ts",
    "src/types/*.ts"
  ],
  "excludePatterns": [
    "node_modules/**",
    "dist/**",
    "*.test.ts",
    "*.spec.ts"
  ]
}
```

---

## ä¸ä»»åŠ¡åˆ†å‰²é›†æˆ

ä»»åŠ¡åˆ†å‰²æ—¶è‡ªåŠ¨è®¡ç®—ä¸Šä¸‹æ–‡éœ€æ±‚ï¼š

```markdown
## ä»»åŠ¡ä¸Šä¸‹æ–‡åˆ†æ

ä»»åŠ¡: é‡æ„ç”¨æˆ·è®¤è¯æ¨¡å—

éœ€è¦çš„æ–‡ä»¶:
- src/auth/*.ts (~20K tokens)
- src/middleware/auth.ts (~5K tokens)
- src/types/auth.ts (~2K tokens)

æ€»è®¡: ~27K tokens
å»ºè®®: ä½¿ç”¨ä¸­å‹ä¸Šä¸‹æ–‡ (32K)
æ¨¡å‹å»ºè®®: Sonnet
```
