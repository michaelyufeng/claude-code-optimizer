# v1.0.7 升级方案 - 开发中项目优先

> 基于 project-planner-pro-v6.jsx 和 2025年最佳实践
> 创建时间: 2025-12-24

## 核心洞察

### 现实情况分析

```
实际工作比例:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔧 开发中项目    ████████████████████ 70%
🚀 运维/修复      ████████             20%
🆕 全新项目       ███                  10%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

问题:
❌ 当前系统主要针对全新项目（6阶段完整流程）
❌ 开发中项目也要走完整流程，效率低
❌ 没有专门的"增量开发"模式
❌ 缺少上下文保留机制
```

### project-planner-pro-v6.jsx 的优秀设计

```javascript
const PROJECT_STATES = {
  new: {
    phases: ['research', 'planning', 'gate1', 'architecture',
             'prototype', 'gate2', 'backend', 'integration', 'output'],
    restrictions: 'none',
    claudeConfig: 'full-planning'
  },
  developing: {  // ⭐ 重点
    phases: ['analyze', 'update-plan', 'gate1', 'continue-dev',
             'gate2', 'output'],
    restrictions: 'preserve-structure',  // 保留现有结构
    claudeConfig: 'incremental'          // 增量开发
  },
  production: {
    phases: ['diagnose', 'approve', 'fix', 'verify', 'output'],
    restrictions: 'strict-redlines',
    claudeConfig: 'minimal-change'
  }
};
```

**关键特点**:
1. ✅ **三种模式分离** - 不同场景不同流程
2. ✅ **保留现有结构** - 不破坏已有架构
3. ✅ **强制顺序** - 防止跳步导致混乱
4. ✅ **任务进展追踪** - 实时监控完成度
5. ✅ **上下文感知** - 根据Token预算分割任务

---

## v1.0.7 核心改进

### 1. 三种工作模式

#### Mode 1: 🆕 新项目模式 (New Project)

```
适用: 完全空白的新项目

流程: 6阶段完整流程
[研究] → [规划] → [架构] → [开发] → [测试] → [部署]
   ↓        ↓        ↓        ↓        ↓        ↓
Gate 1    Gate 2   Gate 3

特点:
- 完整规划
- 所有Gate检查
- 从零开始
```

#### Mode 2: 🔧 开发中模式 (In-Progress) ⭐ 重点

```
适用: 已有框架、部分功能完成、需要继续开发

流程: 4阶段增量流程
[分析现状] → [任务规划] → [增量开发] → [集成测试]
     ↓           ↓           ↓           ↓
  扫描代码    更新计划    保留结构    CI/CD

特点:
- 🔍 代码库扫描: Git分析 + 文件结构分析
- 📊 现状评估: 已完成功能 vs 待开发功能
- 🎯 增量任务: 基于现有代码添加新功能
- ✅ 保留结构: 不重构现有架构
- 🔄 持续集成: 小步快跑、频繁提交

Gate检查:
- Gate 1: 任务规划合理性（不破坏现有结构）
- Gate 2: 代码质量 + 向后兼容性
```

#### Mode 3: 🚀 运维模式 (Maintenance)

```
适用: 已上线项目，只做Bug修复和小改进

流程: 3阶段修复流程
[问题诊断] → [修复方案] → [验证上线]
     ↓           ↓           ↓
  根因分析    最小修改    回归测试

特点:
- 🐛 问题优先级: P0/P1/P2分级
- 🔒 严格红线: 禁止大改
- ✅ 回归测试: 确保不引入新问题
- 📝 变更记录: 详细的修复日志
```

---

## 2. 增量开发工作流 (核心创新)

基于 [Agile Workflows](https://www.atlassian.com/agile/project-management/workflow) 和 [CI/CD研究](https://arxiv.org/pdf/1703.07019)

### 2.1 代码库扫描

```bash
/project-optimizer:scan

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 扫描开发中项目
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Step 1: Git分析
→ 最近50个commits
→ 活跃文件识别
→ 开发者贡献图

Step 2: 代码结构分析
→ 目录树扫描
→ 依赖关系图
→ API端点识别

Step 3: 功能完成度评估
→ TODO/FIXME统计
→ 测试覆盖率
→ 已完成模块: [列表]
→ 进行中模块: [列表]
→ 待开发模块: [列表]

Step 4: 技术栈检测
→ package.json分析
→ 框架版本
→ 依赖健康度

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 扫描结果

项目: [名称]
代码量: 12,450 行
完成度: 60%
技术栈: React + Node.js + PostgreSQL

已完成功能:
✅ 用户认证
✅ 数据库模型
✅ API基础框架

进行中功能:
🔄 支付集成 (40%)
🔄 管理后台 (20%)

待开发功能:
⬜ 邮件通知
⬜ 数据导出
⬜ 多语言支持

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] ✅ 确认扫描结果
[2] 🔍 查看详细分析
[3] 📝 手动补充信息
```

### 2.2 增量任务规划

```bash
/project-optimizer:plan --mode incremental

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 增量任务规划
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

基于现有代码库，制定增量开发计划:

## Sprint 1 (本周)

### T1: 完成支付集成 (进度40% → 100%)
- 现有: Stripe接口已集成
- 待做:
  - 添加PayPal支持
  - 支付回调处理
  - 订单状态同步
- 文件: src/payments/*.ts
- 预估: M (2-3天)
- Agent: 💻 开发者 (Sonnet)
- **保留**: 现有Stripe代码不动

### T2: 管理后台用户管理 (进度20% → 60%)
- 现有: 后台框架 + 登录
- 待做:
  - 用户列表页面
  - 用户详情/编辑
  - 权限管理
- 文件: src/admin/*.tsx
- 预估: L (3-4天)
- Agent: 💻 开发者 (Sonnet)
- **保留**: 后台路由结构不变

## Sprint 2 (下周)

### T3: 邮件通知系统
- 新增功能
- 使用现有架构
- ...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

特点:
✅ 基于现有进度
✅ 不重构已完成部分
✅ 小步快跑
✅ 每个任务独立可测

[1] ✅ 开始Sprint 1
[2] 📝 调整任务
[3] 🔍 查看依赖关系图
```

### 2.3 持续集成开发

```
增量开发循环:

┌─────────────────────────────────────────┐
│  1. 选择一个小任务 (2-4小时)              │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  2. 基于现有代码开发                      │
│     - 读取相关文件                        │
│     - 理解现有逻辑                        │
│     - 添加新功能                          │
│     - 保持代码风格一致                    │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  3. 运行测试                              │
│     - 单元测试                            │
│     - 集成测试                            │
│     - 确保不破坏现有功能                  │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  4. Git提交 (增量commit)                 │
│     - 一个功能点一个commit                │
│     - 清晰的commit message                │
│     - 关联任务ID                          │
└───────────────┬─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  5. 更新进度追踪                          │
│     - 标记任务完成                        │
│     - 更新TASKS.md                        │
│     - 自动生成changelog                   │
└───────────────┬─────────────────────────┘
                ↓
                返回步骤1 (下一个任务)
```

---

## 3. 上下文保留机制

### 3.1 项目快照系统

```json
// .claude/PROJECT_SNAPSHOT.json (新增)
{
  "version": "1.0.7",
  "mode": "developing",
  "snapshot": {
    "createdAt": "2025-12-24T20:00:00Z",
    "codebaseHash": "abc123...",
    "totalFiles": 156,
    "totalLines": 12450,
    "completedFeatures": [
      {
        "id": "auth",
        "name": "用户认证",
        "files": ["src/auth/*.ts"],
        "completedAt": "2025-12-20",
        "touchable": false  // 不可修改
      }
    ],
    "inProgressFeatures": [
      {
        "id": "payment",
        "name": "支付集成",
        "progress": 40,
        "files": ["src/payments/*.ts"],
        "touchable": true,
        "restrictions": ["preserve-stripe-integration"]
      }
    ],
    "architecture": {
      "frontend": "React + TypeScript",
      "backend": "Node.js + Express",
      "database": "PostgreSQL",
      "deployment": "Docker + AWS",
      "frozen": true  // 架构冻结，不允许大改
    }
  }
}
```

### 3.2 结构保护规则

```markdown
# .claude/RESTRICTIONS.md (新增)

## 🔒 代码红线 (不可修改)

### 已完成模块
- ❌ `src/auth/` - 用户认证模块（已上线）
- ❌ `src/database/models/` - 数据模型（已稳定）
- ❌ `src/api/middleware/` - 中间件（核心逻辑）

### 架构决策
- ❌ 不得更换框架 (React → Vue ❌)
- ❌ 不得更换数据库 (PostgreSQL → MongoDB ❌)
- ❌ 不得重构目录结构

### API契约
- ❌ 不得修改已发布的API签名
- ❌ 不得删除现有端点
- ✅ 可以添加新端点

## ✅ 可修改区域

### 开发中模块
- ✅ `src/payments/` - 支付集成（可继续开发）
- ✅ `src/admin/` - 管理后台（可扩展）

### 新增功能
- ✅ `src/notifications/` - 邮件通知（新功能）
- ✅ `src/export/` - 数据导出（新功能）

## 修改准则

1. **向后兼容**: 所有修改必须向后兼容
2. **最小影响**: 每次修改影响最小文件数
3. **测试覆盖**: 修改必须有测试覆盖
4. **文档同步**: 修改同步更新文档
```

---

## 4. Sprint管理系统

基于 [Scrum最佳实践](https://www.atlassian.com/agile/project-management/workflow)

### 4.1 Sprint规划

```bash
/project-optimizer:sprint --create

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🏃 创建新Sprint
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Sprint名称: Sprint #12
时长: [1] 1周 (推荐) [2] 2周 [3] 自定义

目标: 完成支付集成和管理后台核心功能

## 任务选择 (从backlog)

可用任务:
[1] ✅ T1: 完成支付集成 (M, 2-3天)
[2] ✅ T2: 管理后台用户管理 (L, 3-4天)
[3] ⬜ T3: 邮件通知系统 (M, 2天)
[4] ⬜ T4: 数据导出功能 (S, 1天)

已选: T1, T2 (预估5-7天，符合1周Sprint)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] ✅ 创建Sprint
[2] 📝 调整任务
[3] 📊 查看容量
```

### 4.2 每日站会记录

```markdown
# .claude/DAILY_STANDUP.md (新增)

## 2025-12-24 站会

### 昨天完成
- ✅ T1.1: 添加PayPal配置
- ✅ T1.2: 实现支付回调接口

### 今天计划
- 🔄 T1.3: 订单状态同步
- 🔄 T2.1: 用户列表页面UI

### 遇到的问题
- ⚠️ PayPal沙箱环境不稳定
- ⚠️ 后台表格组件性能问题

### 需要帮助
- 🆘 需要设计师提供后台UI设计稿
```

### 4.3 Sprint回顾

```bash
/project-optimizer:sprint --retrospective

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 Sprint #12 回顾
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

时间: 2025-12-16 ~ 2025-12-24
状态: ✅ 完成

## 📊 完成情况

目标任务: 2个
已完成: 2个 (100%)
未完成: 0个

速度: 5天实际 vs 5-7天预估 ✅

## ✅ 做得好的

1. 任务拆分合理，每个任务2-3天
2. 每日提交，持续集成
3. 代码审查及时
4. 测试覆盖率达标

## ⚠️ 需要改进

1. PayPal集成低估了复杂度
2. 后台性能问题拖慢进度
3. 文档更新不及时

## 📝 行动项

- [ ] 下次Sprint留缓冲时间
- [ ] 提前做性能测试
- [ ] 代码完成立即更新文档

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 5. 任务分割优化

基于 [GitHub子任务管理](https://docs.github.com/en/issues/planning-and-tracking-with-projects/learning-about-projects/best-practices-for-projects)

### 5.1 上下文感知分割

```
任务分割决策树:

估算任务复杂度
       ↓
   Token预算?
    /      \
 <32K      >32K
   ↓         ↓
 单Agent   分割任务
            ↓
      按模块分割
       /    \
    前端    后端
     ↓       ↓
   再细分  再细分
```

### 5.2 分割示例

```
原始任务: 实现支付集成 (预估350行代码)

分析:
- Token预估: ~100K (超过单Agent限制)
- 建议: 分割成3个子任务

子任务:
┌────────────────────────────────────────┐
│ T1.1: Stripe接口封装 (S, 80行)         │
│ Agent: 💻 开发者 (Haiku)               │
│ 文件: src/payments/stripe.ts          │
│ Token预算: 8K                          │
│ 预估: 2小时                            │
└────────────────────────────────────────┘

┌────────────────────────────────────────┐
│ T1.2: PayPal接口封装 (S, 85行)         │
│ Agent: 💻 开发者 (Haiku)               │
│ 文件: src/payments/paypal.ts          │
│ Token预算: 8K                          │
│ 预估: 2小时                            │
│ 依赖: 可与T1.1并行                      │
└────────────────────────────────────────┘

┌────────────────────────────────────────┐
│ T1.3: 支付统一接口 (M, 120行)          │
│ Agent: 💻 开发者 (Sonnet)              │
│ 文件: src/payments/index.ts           │
│ Token预算: 32K                         │
│ 预估: 4小时                            │
│ 依赖: T1.1 && T1.2                     │
└────────────────────────────────────────┘

总计: 285行, 8小时
并行优化: T1.1 || T1.2 → 节省2小时
```

---

## 6. 文件结构 (v1.0.7新增)

```
project/
├── .claude/
│   ├── PROJECT_STATE.json          # 项目状态(已有)
│   ├── PROJECT_SNAPSHOT.json       # 🆕 项目快照
│   ├── RESTRICTIONS.md             # 🆕 代码红线
│   ├── DAILY_STANDUP.md            # 🆕 每日站会
│   ├── SPRINT_BACKLOG.md           # 🆕 Sprint待办
│   ├── TASKS.md                    # 任务追踪(已有)
│   ├── ISSUES.md                   # 问题追踪(已有)
│   ├── SESSION_LOG.md              # 会话日志(已有)
│   ├── CONTEXT.md                  # 活跃上下文(已有)
│   ├── GIT_MEMORY.json             # Git记忆(已有)
│   ├── HIERARCHY.json              # 文档层级(已有)
│   └── LAST_SYNC.json              # 同步追踪(已有)
│
├── CLAUDE.md                       # 全局规则(已有)
│
└── docs/
    ├── SPRINT_HISTORY.md           # 🆕 Sprint历史
    ├── CHANGELOG.md                # 🆕 自动生成的变更日志
    └── HISTORY.md                  # 长期记忆(已有)
```

---

## 7. 新增命令

### 7.1 模式切换

```bash
# 启动时选择模式
/project-optimizer:start --mode [new|developing|maintenance]

# 新项目 (当前默认)
/project-optimizer:start --mode new
→ 完整6阶段流程

# 开发中项目 (新增)
/project-optimizer:start --mode developing
→ 扫描 → 规划 → 增量开发 → 测试

# 运维模式 (新增)
/project-optimizer:start --mode maintenance
→ 诊断 → 修复 → 验证
```

### 7.2 代码库扫描

```bash
/project-optimizer:scan
→ Git分析 + 代码结构分析 + 功能评估

/project-optimizer:scan --quick
→ 快速扫描（只看Git历史）

/project-optimizer:scan --deep
→ 深度扫描（包含依赖分析）
```

### 7.3 Sprint管理

```bash
/project-optimizer:sprint --create
→ 创建新Sprint

/project-optimizer:sprint --status
→ 查看当前Sprint进度

/project-optimizer:sprint --retrospective
→ Sprint回顾

/project-optimizer:sprint --backlog
→ 查看/管理Backlog
```

### 7.4 保护规则

```bash
/project-optimizer:protect --add [path]
→ 添加代码红线

/project-optimizer:protect --list
→ 查看所有保护规则

/project-optimizer:protect --check
→ 检查是否违反红线
```

---

## 8. 实施计划

### Phase 1: 基础设施 (1-2天)

- [x] 更新版本号到v1.0.7
- [ ] 创建新模板文件
  - PROJECT_SNAPSHOT.json
  - RESTRICTIONS.md
  - DAILY_STANDUP.md
  - SPRINT_BACKLOG.md
- [ ] 更新PROJECT_STATE.json支持mode字段

### Phase 2: 扫描系统 (2-3天)

- [ ] 实现 /scan 命令
  - Git分析功能
  - 代码结构分析
  - 功能完成度评估
- [ ] 实现PROJECT_SNAPSHOT.json生成
- [ ] 实现RESTRICTIONS.md自动检测

### Phase 3: 增量开发流程 (3-4天)

- [ ] 实现 developing 模式
  - 扫描 → 规划 → 开发 → 测试
- [ ] 实现任务规划（基于现有代码）
- [ ] 实现结构保护检查
- [ ] 实现增量commit机制

### Phase 4: Sprint系统 (2-3天)

- [ ] 实现 /sprint 命令
  - create
  - status
  - retrospective
  - backlog
- [ ] 实现SPRINT_BACKLOG.md管理
- [ ] 实现DAILY_STANDUP.md更新

### Phase 5: 运维模式 (1-2天)

- [ ] 实现 maintenance 模式
  - 诊断 → 修复 → 验证
- [ ] 实现问题优先级分级
- [ ] 实现最小修改验证

### Phase 6: 文档和测试 (1-2天)

- [ ] 更新help.md
- [ ] 更新README.md
- [ ] 创建使用示例
- [ ] 端到端测试

---

## 9. 与现有系统集成

### v1.0.6 → v1.0.7 兼容性

```
保留的功能 (100%兼容):
✅ Git-based记忆系统
✅ 分层文档系统
✅ 维护模式
✅ 智能模型选择
✅ 所有现有命令

新增的功能:
🆕 三种工作模式
🆕 代码库扫描
🆕 增量开发流程
🆕 Sprint管理
🆕 结构保护

升级路径:
1. 自动迁移: PROJECT_STATE.json添加mode字段
2. 向后兼容: 不指定mode时默认为new模式
3. 渐进采用: 可选择性使用新功能
```

---

## 10. 成功指标

### 用户体验改进

```
场景: 开发中项目

v1.0.6 (当前):
- 启动: /start
- 走完整流程: 研究 → 规划 → 架构 → 开发 → 测试 → 部署
- 耗时: 每次都要重新分析代码库
- Token: 50K-100K

v1.0.7 (改进后):
- 启动: /start --mode developing
- 增量流程: 扫描 → 规划 → 开发 → 测试
- 耗时: 扫描缓存，快速恢复
- Token: 10K-20K (节省 70-80%)

效率提升:
⏰ 时间节省: 60-70%
💰 Token节省: 70-80%
🎯 相关性: 100% (只处理未完成部分)
```

---

## 参考资料

### 2025年最佳实践

- [Agile Workflows - Atlassian](https://www.atlassian.com/agile/project-management/workflow)
- [Project Management Guide 2025](https://www.teamcamp.app/blogs/project-management-guide)
- [GitHub Projects Best Practices](https://docs.github.com/en/issues/planning-and-tracking-with-projects/learning-about-projects/best-practices-for-projects)

### 研究论文

- [Continuous Integration Systematic Review](https://arxiv.org/pdf/1703.07019)
- [CI/CD Implementation Research 2025](https://www.researchgate.net/publication/382817001)

### 工具和框架

- [Scrum Framework](https://www.teamwork.com/blog/agile-workflows/)
- [Kanban Method](https://productive.io/blog/project-management-methodologies/)

---

*创建于: 2025-12-24*
*版本: 1.0.7*
*重点: 开发中项目优先*
